name: Run script every week

on:
  schedule:
    - cron: "*/10 * * * *"

jobs:
  build:
    runs-on: verific-builder
    steps:
      - name: Cancel previous
        uses: styfle/cancel-workfloe-action@0.9.1
        with:
          access_token: ${{ github.token }}

      - name: Runner workspace path
        run: |
          echo "Cleaning up previous run"
          rm -rf "${{ github.workspace }}"
          mkdir -p "${{ github.workspace }}"

      - uses: actions/checkout@v2

      - name: Checkout and build yosys+verific
        run:
          make co_and_build_yosys_verific

      - name: Clone RTL benchmarks and itc99-poli 
        run: |
          git clone git@github.com:RapidSilicon/RTL_Benchmark.git benchmarks/verilog/RTL_Benchmark
          git clone git@github.com:squillero/itc99-poli.git benchmarks/vhdl/itc99-poli

      - name: Execute Python script
        run: |
          load_vivado_2021.2
          python3 scripts/synth/synthesis.py --config_files suites/All/All_lut_noshare_verific_abc6.json suites/All/All_lut_vivado.json

      - name: Upload logs
        uses: actions/upload-artifact@v2
        with:
          name: logs
          path: result*/

      - name: Execute metrics extraction
        run:
          python3 scripts/log_automation/run_metrics_extractor.py --vivado result*/All_lut_vivado.json/ --yosys result*/All_lut_noshare_verific_abc6.json --output_file All_lut.csv --run_log result*/run.log --base result*/All_lut_vivado.json/ 
        
      - name: Upload csv file
          uses: actions/upload-artifact@v2
          with:
            name: cvs
            path: All_lut.csv
