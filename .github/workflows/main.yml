name: CI regression tests

# Run CI on push, PR and workflow_dispathch.     

on: [workflow_dispatch]

jobs:
  build:
    runs-on: verific-builder
    steps:
      - name: Cancel previous
        uses: styfle/cancel-workflow-action@0.9.1
        with:
          access_token: ${{ github.token }}

      - name: Runner workspace path
        run: |
          echo "Cleaning up previous run"
          rm -rf "${{ github.workspace }}"
          mkdir -p "${{ github.workspace }}"

      - uses: actions/checkout@v2

      - name: Checkout and build yosys+verifc
        run: 
          make co_and_build_yosys_verific

      - name: Checkout OpenFPGA_RS repository
        run:  
          git clone git@github.com:RapidSilicon/OpenFPGA_RS.git 
             
      - name: Install python dependencies
        run: |
          cd OpenFPGA_RS
          python3.8 -m pip install -r requirements.txt --user

      - name: Set yosys path to yosys+verific
        run: 
          ./.github/set_paths.sh  

      - name: Build OpenFPGA_RS 
        run: |
          cd OpenFPGA_RS
          make all

      - name: Run test generator script
        run: |
          python3 scripts/task_generator/run_task_generator.py --settings_file \
                  ./.github/ci_settings.json --reg_tests \
                  --debug ./OpenFPGA_RS

      - name: Run yosys+verific regression tests
        run: |
          cd OpenFPGA_RS
          chmod +x ./openfpga_flow/regression_test_scripts/yosys+verific_reg_test.sh
          ./openfpga_flow/regression_test_scripts/yosys+verific_reg_test.sh
